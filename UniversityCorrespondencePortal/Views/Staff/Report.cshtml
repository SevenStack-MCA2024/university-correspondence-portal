@model UniversityCorrespondencePortal.Models.ViewModels.StaffReportViewModel
@{
    ViewBag.Title = "Staff Dashboard";
    Layout = "~/Views/Shared/_StaffLayout.cshtml";
}

<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet" />
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels@2.0.0"></script>

<div class="container-fluid mt-4">
    <h2><i class="fas fa-tachometer-alt"></i> Staff Dashboard</h2>
    <p class="text-muted">Analytics for @Session["StaffName"]</p>

    <!-- Summary Cards -->
    <div class="row mb-4">
        <div class="col-md-4 mb-3">
            <div class="card border-left-primary shadow h-100 py-2">
                <div class="card-body d-flex justify-content-between">
                    <div>
                        <div class="text-xs font-weight-bold text-primary text-uppercase mb-1">Assigned Letters</div>
                        <div class="h5 mb-0 font-weight-bold">@Model.TotalInward</div>
                    </div>
                    <i class="fas fa-envelope fa-2x text-gray-300"></i>
                </div>
            </div>
        </div>
        <div class="col-md-4 mb-3">
            <div class="card border-left-success shadow h-100 py-2">
                <div class="card-body d-flex justify-content-between">
                    <div>
                        <div class="text-xs font-weight-bold text-success text-uppercase mb-1">Sent Letters</div>
                        <div class="h5 mb-0 font-weight-bold">@Model.TotalOutward</div>
                    </div>
                    <i class="fas fa-paper-plane fa-2x text-gray-300"></i>
                </div>
            </div>
        </div>
        <div class="col-md-4 mb-3">
            <div class="card border-left-warning shadow h-100 py-2">
                <div class="card-body d-flex justify-content-between">
                    <div>
                        <div class="text-xs font-weight-bold text-warning text-uppercase mb-1">Pending Letters</div>
                        <div class="h5 mb-0 font-weight-bold">@ViewBag.PendingLetters</div>
                    </div>
                    <i class="fas fa-exclamation-circle fa-2x text-gray-300"></i>
                </div>
            </div>
        </div>
    </div>

    <!-- Charts -->
    <div class="row mb-4">
        <div class="col-md-6">
            <canvas id="lettersByPriorityChart" height="250"></canvas>
        </div>
        <div class="col-md-6">
            <canvas id="statusChart" height="250"></canvas>
        </div>
    </div>
    <div class="row mb-4">
        <div class="col-md-6 offset-md-3">
            <canvas id="senderDepartmentsChart" height="250"></canvas>
        </div>
    </div>

    <!-- Recent Activity Table -->
    <div class="card shadow mb-4">
        <div class="card-header"><strong>Recent Letter Activity</strong></div>
        <div class="card-body table-responsive">
            <table class="table table-bordered table-sm">
                <thead class="table-light">
                    <tr>
                        <th>Letter #</th>
                        <th>Type</th>
                        <th>Subject</th>
                        <th>Department</th>
                        <th>Status</th>
                        <th>Days Open</th>
                    </tr>
                </thead>
                <tbody>
                    @foreach (var l in ViewBag.RecentLetters)
                    {
                        <tr>
                            <td>@l.LetterNumber</td>
                            <td>@l.Type</td>
                            <td>@l.Subject</td>
                            <td>@l.Department</td>
                            <td><span class="badge badge-@l.StatusClass">@l.Status</span></td>
                            <td>@l.DaysOpen</td>
                        </tr>
                    }
                </tbody>
            </table>
        </div>
    </div>
</div>

@section Scripts {
    <script>
        const pieOptions = {
            maintainAspectRatio: false,
            plugins: {
                legend: { position: 'right' },
                datalabels: {
                    formatter: (val, ctx) => {
                        let sum = ctx.dataset.data.reduce((a, b) => a + b, 0);
                        return ((val * 100 / sum).toFixed(1)) + "%";
                    },
                    color: '#fff'
                }
            }
        };

        new Chart('lettersByPriorityChart', {
            type: 'bar',
            data: {
                labels: @Html.Raw(Json.Encode(ViewBag.PriorityLabels)),
                datasets: [{
                    label: 'Letters',
                    data: @Html.Raw(Json.Encode(ViewBag.PriorityCounts)),
                    backgroundColor: ['#4e73df', '#1cc88a', '#f6c23e', '#e74a3b']
                }]
            },
            options: {
                maintainAspectRatio: false,
                plugins: { legend: { display: false } }
            }
        });

        new Chart('statusChart', {
            type: 'pie',
            data: {
                labels: @Html.Raw(Json.Encode(ViewBag.StatusLabels)),
                datasets: [{
                    data: @Html.Raw(Json.Encode(ViewBag.StatusData)),
                    backgroundColor: ['#4e73df', '#1cc88a', '#f6c23e', '#e74a3b']
                }]
            },
            options: pieOptions,
            plugins: [ChartDataLabels]
        });

        new Chart('senderDepartmentsChart', {
            type: 'pie',
            data: {
                labels: @Html.Raw(Json.Encode(ViewBag.SenderDepartments)),
                datasets: [{
                    data: @Html.Raw(Json.Encode(ViewBag.SenderDepartmentCounts)),
                    backgroundColor: ['#4e73df', '#1cc88a', '#f6c23e', '#e74a3b', '#36b9cc', '#858796']
                }]
            },
            options: pieOptions,
            plugins: [ChartDataLabels]
        });
    </script>
}
